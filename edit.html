<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Cards & Settings</title>
  <style>
    body {
      font-family: "Noto Sans TC", "Microsoft JhengHei", sans-serif;
      margin: 0;
      padding: 20px;
      background-color: #fafafa;
      box-sizing: border-box;
    }
    h1 {
      text-align: center;
      font-size: 24px;
    }
    .container {
      max-width: 800px;
      margin: 0 auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }
    th, td {
      padding: 10px;
      border: 1px solid #ccc;
      text-align: center;
    }
    button {
      padding: 6px 12px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
    }
    .delete { background-color: #e74c3c; color: white; }
    .add-section {
      margin-top: 20px;
      text-align: center;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
    }
    .add-section textarea {
      font-size: 16px;
      padding: 5px;
      width: 90%;
      max-width: 300px;
      height: 80px;
      resize: vertical;
      vertical-align: top;
      margin-bottom: 10px;
    }
    .add-section button {
      background-color: #1e90ff; color: white; padding: 10px 15px;
    }
    .back-btn {
      display: inline-block; margin-bottom: 20px; background-color: #555;
      color: white; padding: 8px 15px; text-decoration: none; border-radius: 4px;
    }
    
    th[onclick] {
        cursor: pointer;
        position: relative;
    }
    th[onclick]:hover {
        background-color: #f0f0f0;
    }
    th[onclick].sort-asc::after,
    th[onclick].sort-desc::after {
        content: '';
        font-size: 0.8em;
        padding-left: 5px;
        position: absolute;
        right: 10px;
    }
    th[onclick].sort-asc::after { content: '▲'; }
    th[onclick].sort-desc::after { content: '▼'; }

    .cloud-sync {
        margin: 20px 0; padding: 15px; border: 1px solid #1e90ff;
        border-radius: 8px; display: flex; flex-direction: column;
        gap: 10px;
    }
    .cloud-sync h2 { margin: 0 0 10px 0; font-size: 18px; text-align: center; }
    .cloud-sync input {
        padding: 8px; border: 1px solid #ccc; border-radius: 4px; width: 100%;
        box-sizing: border-box;
    }
    .cloud-sync button { background-color: #2ecc71; color: white; padding: 10px; }
    #syncStatus { font-size: 14px; text-align: center; }

    @media (max-width: 600px) {
      body { padding: 10px; }
      #cardTable thead { display: none; }
      #cardTable tr {
        display: block; margin-bottom: 15px; border: 1px solid #ddd;
        border-radius: 5px; padding: 10px;
      }
      #cardTable td {
        display: block; text-align: right; position: relative; padding-left: 50%;
        border: none; border-bottom: 1px solid #eee;
      }
      #cardTable td:last-child { border-bottom: none; }
      #cardTable td::before {
        content: attr(data-label); position: absolute; left: 10px;
        width: calc(50% - 20px); padding-right: 10px; font-weight: bold;
        text-align: left;
      }
    }
  </style>
</head>
<body>
<div class="container">
  <a href="index.html" class="back-btn">← Back to Main</a>
  <h1>Edit Cards & Settings</h1>

  <div class="cloud-sync">
      <h2>GitHub Gist Sync</h2>
      <input type="password" id="accessToken" placeholder="GitHub Personal Access Token">
      <input type="text" id="gistId" placeholder="Gist ID">
      <button onclick="setupSync()">Save & Connect</button>
      <span id="syncStatus">Enter your credentials to enable cloud sync.</span>
  </div>

  <div class="add-section">
    <textarea id="newChars" placeholder="Enter characters to add or reset here"></textarea>
    <button onclick="addChars()">Bulk Add / Reset</button>
  </div>

  <table id="cardTable">
    <thead>
      <tr>
        <th id="th-char" onclick="sortTable('char')">Character</th>
        <th id="th-interval" onclick="sortTable('interval')">Interval</th>
        <th id="th-ease" onclick="sortTable('ease')">Ease</th>
        <th id="th-due" onclick="sortTable('due')">Next Review</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>
</div>
  <script>
    let cards = {};
    let sortKey = 'char';
    let sortDirection = 'asc';
    
    const GIST_API_BASE = 'https://api.github.com/gists/';
    const GIST_FILENAME = 'progress.json';
    let accessToken = '';
    let gistId = '';

    function updateSyncStatus(message, isError = false) {
      const statusEl = document.getElementById('syncStatus');
      statusEl.textContent = message;
      statusEl.style.color = isError ? '#e74c3c' : '#2c3e50';
    }

    async function setupSync() {
      const tokenInput = document.getElementById('accessToken').value;
      const gistIdInput = document.getElementById('gistId').value;
      if (!tokenInput || !gistIdInput) {
        return alert('Please provide both GitHub Access Token and Gist ID.');
      }
      accessToken = tokenInput;
      gistId = gistIdInput;
      localStorage.setItem('ankiAccessToken', accessToken);
      localStorage.setItem('ankiGistId', gistId);
      
      updateSyncStatus('Testing connection...', false);
      await loadProgress();
      renderTable();
    }

    function loadCredentials() {
      accessToken = localStorage.getItem('ankiAccessToken') || '';
      gistId = localStorage.getItem('ankiGistId') || '';
      if (accessToken && gistId) {
        document.getElementById('accessToken').value = accessToken;
        document.getElementById('gistId').value = gistId;
      }
    }

    async function saveToCloud() {
      if (!accessToken || !gistId) return;
      try {
        const response = await fetch(`${GIST_API_BASE}${gistId}`, {
          method: 'PATCH',
          headers: {
            'Authorization': `token ${accessToken}`, 'Accept': 'application/vnd.github.v3+json',
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ files: { [GIST_FILENAME]: { content: JSON.stringify(cards, null, 2) } } })
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
      } catch (error) {
        console.error('Failed to save to Gist:', error);
        alert('Cloud sync failed. Changes might not be saved.');
      }
    }

    async function loadFromCloud() {
      if (!accessToken || !gistId) return false;
      try {
        const response = await fetch(`${GIST_API_BASE}${gistId}`, {
          method: 'GET',
          headers: { 'Authorization': `token ${accessToken}`, 'Accept': 'application/vnd.github.v3+json' }
        });
        if (!response.ok) throw new Error(`HTTP error! Status: ${response.status}`);
        const data = await response.json();
        if (data.files && data.files[GIST_FILENAME]) {
            const content = data.files[GIST_FILENAME].content;
            cards = content ? JSON.parse(content) : {};
        }
        updateSyncStatus('Successfully connected to Gist.', false);
        return true;
      } catch (error) {
        console.error('Failed to load from Gist:', error);
        updateSyncStatus('Connection Failed. Check Token/ID or Gist file.', true);
        return false;
      }
    }

    async function loadProgress() {
      const cloudSuccess = await loadFromCloud();
      if (!cloudSuccess) {
        const saved = localStorage.getItem("ankiCards");
        if (saved) cards = JSON.parse(saved);
        updateSyncStatus('Using local save. Connect to GitHub Gist to enable cloud sync.', true);
      }
    }

    function saveProgress() {
      if (accessToken && gistId) {
        saveToCloud();
      } else {
        localStorage.setItem("ankiCards", JSON.stringify(cards));
      }
    }

    function formatInterval(minutes) {
      if (minutes < 60) return `${Math.max(1, Math.round(minutes))}m`;
      const hours = minutes / 60;
      if (hours < 24) return `${Math.round(hours)}h`;
      return `${Math.round(hours / 24)}d`;
    }

    function renderTable() {
      document.querySelectorAll('th[onclick]').forEach(th => {
        th.classList.remove('sort-asc', 'sort-desc');
      });
      const activeHeader = document.getElementById(`th-${sortKey}`);
      if (activeHeader) {
        activeHeader.classList.add(sortDirection === 'asc' ? 'sort-asc' : 'sort-desc');
      }
      const tbody = document.querySelector("#cardTable tbody");
      tbody.innerHTML = "";
      const sortedCards = Object.values(cards).sort((a, b) => {
        let valA = a[sortKey], valB = b[sortKey];
        if (['interval', 'ease', 'due'].includes(sortKey)) {
            valA = Number(valA); valB = Number(valB);
        }
        if (valA < valB) return sortDirection === 'asc' ? -1 : 1;
        if (valA > valB) return sortDirection === 'asc' ? 1 : -1;
        return 0;
      });
      sortedCards.forEach(card => {
        const tr = document.createElement("tr");
        const dueDate = new Date(card.due);
        tr.innerHTML = `
          <td data-label="Character">${card.char}</td>
          <td data-label="Interval">${Math.round(card.interval)} (${formatInterval(card.interval)})</td>
          <td data-label="Ease">${Math.round(card.ease)}%</td>
          <td data-label="Next Review">${dueDate.toLocaleString()}</td>
          <td data-label="Action"><button class="delete" onclick="deleteChar('${card.char}')">Delete</button></td>
        `;
        tbody.appendChild(tr);
      });
    }

    function sortTable(key) {
        sortDirection = (sortKey === key && sortDirection === 'asc') ? 'desc' : 'asc';
        sortKey = key;
        renderTable();
    }

    function deleteChar(ch) {
      if (confirm(`Are you sure you want to delete '${ch}'? This action cannot be undone.`)) {
        delete cards[ch];
        saveProgress();
        renderTable();
      }
    }

    function addChars() {
      const textarea = document.getElementById("newChars");
      const text = textarea.value.trim();
      if (!text) return alert("Please enter characters to process.");
      const uniqueChars = [...new Set(text.split('').filter(c => c.trim()))];
      let addedCount = 0, resetCount = 0;
      uniqueChars.forEach(ch => {
        if (cards[ch]) resetCount++; else addedCount++;
        cards[ch] = { char: ch, interval: 0, ease: 250, due: Date.now() };
      });
      if (addedCount > 0 || resetCount > 0) {
        saveProgress();
        renderTable();
        let msg = [];
        if (addedCount > 0) msg.push(`Added ${addedCount} new character(s)`);
        if (resetCount > 0) msg.push(`Reset ${resetCount} existing character(s)`);
        alert(`Success: ${msg.join(', ')}.`);
        textarea.value = "";
      } else {
        alert("No valid characters were entered.");
      }
    }

    (async () => {
      loadCredentials();
      await loadProgress();
      renderTable();
    })();
  </script>
</body>
</html>